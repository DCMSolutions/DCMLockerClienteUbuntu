@page "/assets"

@implements IAsyncDisposable
@inject IJSRuntime JS

<style>
    html, body {
        height: 100%;
        overflow: hidden;
    }

    .kiosk-full {
        height: 100vh;
    }

    .kiosk-up {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 6vh;
    }

    .kiosk-center {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 100vh;
    }

    .action-card, .asset-card, .state-card {
        min-height: 24vh;
        border-width: 2px;
        transition: transform .08s, box-shadow .08s;
        cursor: pointer;
    }

        .action-card:active, .asset-card:active, .state-card:active {
            transform: scale(0.99);
        }

        .action-card .card-body, .asset-card .card-body, .state-card .card-body {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

    .selected {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }

    .progress-bar {
        transition: width .3s linear;
    }

    /* Estado visual de assets en selección de RETIRO */
    .asset-card.asset-defectuoso {
        background: #dc3545; /* rojo */
        color: #fff;
        border-color: #dc3545;
    }

    .asset-card.asset-warning {
        background: #ffc107; /* amarillo */
        color: #212529;
        border-color: #ffc107;
    }

    /* Cuando está seleccionado, mantenemos color de estado; si es funcional (sin clase), va azul */
    .asset-card.selected {
        box-shadow: 0 0 0 4px rgba(0,123,255,.35);
    }

        .asset-card.selected:not(.asset-defectuoso):not(.asset-warning) {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }

    /* Botón invisible */
    .hidden-admin-trigger {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 10vh; 
        background: transparent;
        border: 0;
        opacity: 0; /* invisible pero clickeable */
        z-index: 10;
    }

    /* Pantalla PIN */
    .pin-dots {
        letter-spacing: .35rem;
        font-size: 2rem;
        user-select: none;
    }

    .keypad button {
        min-width: 84px;
        min-height: 84px;
        font-size: 1.6rem;
    }

    .select-layout {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-top: 4vh;
        padding-bottom: 4vh;
    }

    .select-hero {
        height: 42vh;               /* espacio del “banner” */
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
    }

    /* cuando hay RFID, dejamos el espacio en blanco (sin imagen) */
    .select-hero.blank {
        background-image: none !important;
        background-color: transparent;
    }

    /* imagen por defecto */
    .select-hero.image {
        background-image: url("/img/1-rfid-hand");
    }

    .select-message {
        text-align: center;
        font-size: 1.25rem;
        color: #6c757d;
        margin-top: 1rem;
        min-height: 2.2rem; /* evita saltos visuales */
    }

    .select-bottom {
        text-align: center;
    }

    .select-bottom h6 {
        color: #6c757d;
        margin-bottom: 0.75rem;
    }

    /* Botones de opción: azules por defecto y resaltado al seleccionar */
    .option-btn {
        min-width: 160px;
        padding: .6rem 1.25rem;
        font-size: 1.05rem;
        margin: .25rem .5rem;
        transition: transform .08s, box-shadow .08s;
    }
    .option-btn:active { transform: scale(0.98); }

    /* Ambos son azules; al seleccionar, agregamos un “ring” y negrita */
    .option-btn.is-selected {
        box-shadow: 0 0 0 4px rgba(0,123,255,.35);
        font-weight: 600;
    }
</style>

<div class="container kiosk-full">

    @if (_screen == Screen.Select)
    {
        <div class="select-layout">
            <!-- Top: imagen grande + mensaje -->
            <div>
                <div class="select-hero @(string.IsNullOrEmpty(_rfid) ? "image" : "blank")"></div>

                <div class="select-message">
                    @if (string.IsNullOrEmpty(_rfid))
                    {
                        <span>Acerque la tarjeta al lector para comenzar a operar</span>
                    }
                    else
                    {
                        <span>Bienvenido/a</span>
                    }
                </div>
            </div>

            <!-- Bottom: acciones -->
            <div class="select-bottom">
                <h6>Seleccione una opción</h6>
                <div class="d-flex justify-content-center flex-wrap">
                    <!-- Ingresar ≡ Devolución -->
                    <button class="btn btn-primary option-btn @(IsSelected(AssetsAccion.Devolucion) ? "is-selected" : "")"
                            @onclick="() => SelectAccion(AssetsAccion.Devolucion)">
                        Ingresar
                    </button>

                    <!-- Retirar ≡ Retiro -->
                    <button class="btn btn-primary option-btn @(IsSelected(AssetsAccion.Retiro) ? "is-selected" : "")"
                            @onclick="() => SelectAccion(AssetsAccion.Retiro)">
                        Retirar
                    </button>
                </div>
            </div>
        </div>

        <button class="hidden-admin-trigger" title=""
                @onclick="() => _screen = Screen.SecretPin"
                tabindex="-1"></button>
    }
    else if (_screen == Screen.SecretPin)
    {
        <div class="kiosk-center text-center">
            <h4 class="mb-3">Acceso</h4>
            <div class="pin-dots mb-4">@(new string('*', _pinInput.Length))</div>

            <div class="d-flex justify-content-center">
                <div class="keypad">
                    @for (var fila = 0; fila < 3; fila++)
                    {
                        <div class="mb-2 text-center">
                            @for (var col = 1; col <= 3; col++)
                            {
                                var d = (fila * 3 + col).ToString();
                                <button class="btn btn-outline-secondary m-1"
                                        @onclick="@(() => PinAdd(d))">
                                    @d
                                </button>
                            }
                        </div>
                    }

                    <div class="mb-3 text-center">
                        <button class="btn btn-outline-secondary m-1" @onclick="PinClear">C</button>
                        <button class="btn btn-outline-secondary m-1" @onclick="@(() => PinAdd("0"))">0</button>
                        <button class="btn btn-outline-secondary m-1" @onclick="PinBackspace">←</button>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-primary mr-2"
                                disabled="@(_pinInput.Length == 0)"
                                @onclick="SubmitPin">
                            Ingresar
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="PinCancel">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    }

    else if (_screen == Screen.Loading)
    {
        <div class="kiosk-center text-center">
            <div class="spinner-border text-primary mb-3" role="status"><span class="sr-only">Cargando...</span></div>
            <div class="text-muted">@_loadingText</div>
        </div>
    }
    else if (_screen == Screen.ChooseAsset)
    {
        <div class="kiosk-up">
            <div class="text-center mb-3">
                <h4 class="m-0">Seleccione el asset a retirar</h4>
                @if (!string.IsNullOrEmpty(_employeeName))
                {
                    <div class="text-muted">Empleado: @_employeeName</div>
                }
            </div>

            @if (_assets.Count == 0)
            {
                <div class="text-center text-muted">No hay assets disponibles para retiro.</div>
                <div class="text-center mt-4"><button class="btn btn-outline-secondary" @onclick="Reset">Volver</button></div>
            }
            else
            {
                <div class="row justify-content-center">
                    @foreach (var a in _assets)
                    {
                        var isSel = _selectedAsset?.IdAsset == a.IdAsset;
                        <div class="col-12 col-md-6 col-lg-5 mb-4">
                            <div class="card asset-card shadow-sm @AssetCardClasses(a, isSel)"
                                 @onclick="@(() => SelectAsset(a))">
                                <div class="card-body text-center">
                                    <div>
                                        <h5 class="mb-2">@a.NombreAsset</h5>
                                        <div class="small @(isSel ? "text-white-50" : "text-muted")">
                                            ID: @a.IdAsset &nbsp;|&nbsp; Box: @a.IdBox
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="text-center">
                    <button class="btn btn-primary btn-lg" disabled="@(_selectedAsset == null)" @onclick="GoConfirmRetiro">Continuar</button>
                    <button class="btn btn-outline-secondary btn-lg ml-2" @onclick="Reset">Cancelar</button>
                </div>
            }
        </div>
    }
    @* else if (_screen == Screen.ConfirmRetiro)
    {
        <div class="kiosk-center text-center">
            <h4 class="mb-3">¿Confirmar retiro?</h4>
            <div class="mb-3">
                <div class="lead mb-1">@_selectedAsset?.NombreAsset</div>
                <div class="text-muted">ID: @_selectedAsset?.IdAsset &nbsp;|&nbsp; Box: @_selectedAsset?.IdBox</div>
            </div>

            <div>
                <button class="btn btn-success btn-lg mr-2" @onclick="SendRetiro">Sí, confirmar</button>
                <button class="btn btn-outline-secondary btn-lg" @onclick="CancelConfirm">No, volver</button>
            </div>
        </div>
    } *@
    else if (_screen == Screen.ScanQr)
    {
        <div class="kiosk-center text-center">
            <div class="mb-3">
                <h4 class="m-0">Escanee el QR de su activo</h4>
                @if (!string.IsNullOrEmpty(_employeeName))
                {
                    <div class="text-muted">Empleado: @_employeeName</div>
                }
            </div>
            <div class="text-muted mb-4">Acerque el código frente al lector…</div>
            <div><button class="btn btn-outline-secondary" @onclick="Reset">Cancelar</button></div>
        </div>
    }
    else if (_screen == Screen.DevolucionSetEstado)
    {
        <div class="kiosk-up">
            <div class="text-center mb-3">
                <h4 class="m-0">Activo seleccionado</h4>
                <div class="text-muted">ID: @_selectedAsset?.IdAsset &nbsp;|&nbsp; Box: @_selectedAsset?.IdBox</div>
                <div class="lead mt-2">@_selectedAsset?.NombreAsset</div>
            </div>

            <div class="text-center mb-3">
                <p class="m-0">Seleccione estado del activo</p>
            </div>

            <div class="row justify-content-center">
                <div class="col-sm-6 col-md-5 col-lg-4 mb-4">
                    <div class="card state-card shadow-sm @(_devolEstado == AssetsEstado.Funcional ? "selected" : "border-secondary")"
                         @onclick="@(() => SelectEstado(AssetsEstado.Funcional))">
                        <div class="card-body text-center"><h5>Funcional</h5></div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-5 col-lg-4 mb-4">
                    <div class="card state-card shadow-sm @(_devolEstado == AssetsEstado.Defectuoso ? "selected" : "border-secondary")"
                         @onclick="@(() => SelectEstado(AssetsEstado.Defectuoso))">
                        <div class="card-body text-center"><h5>Defectuoso</h5></div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="btn btn-primary btn-lg" disabled="@(_devolEstado is null)" @onclick="ProceedDevolucion">
                    Continuar
                </button>
                <button class="btn btn-outline-secondary btn-lg ml-2" @onclick="Reset">Cancelar</button>
            </div>
        </div>
    }
    else if (_screen == Screen.Result)
    {
        <div class="kiosk-center">
            <div class="mb-3">
                <h4>Respuesta</h4>
                <pre class="bg-light p-3 rounded" style="white-space:pre-wrap; word-break:break-word;">@_resultRaw</pre>
            </div>

            <div class="mb-2 text-muted text-center">Volviendo en @_countdown s…</div>
            <div class="progress mb-3" style="height: 12px;">
                <div class="progress-bar" role="progressbar" style="width:@PercentDone()"></div>
            </div>

            <div class="text-center">
                <button class="btn btn-outline-secondary btn-sm" @onclick="Reset">Volver ahora</button>
            </div>
        </div>
    }
    else if (_screen == Screen.Admin)
    {
        <div class="kiosk-up">
            <div class="text-center mb-3">
                <h4 class="m-0">Administrador</h4>
            </div>

            <div class="row justify-content-center">
                <div class="col-12 col-lg-10">
                    <div class="card shadow-sm border-secondary mb-4">
                        <div class="card-body">
                            <div class="d-flex flex-wrap justify-content-center mb-3">
                                <button class="btn btn-danger m-2" @onclick="AdminShutdown" disabled="@_adminBusy">Apagar</button>
                                <button class="btn btn-warning m-2" @onclick="AdminReset" disabled="@_adminBusy">Reiniciar</button>
                                <button class="btn btn-primary m-2" @onclick="AdminUpdate" disabled="@_adminBusy">Actualizar</button>
                                <button class="btn btn-outline-secondary m-2" @onclick="AdminBack" disabled="@_adminBusy">Volver</button>
                            </div>

                            @if (!string.IsNullOrEmpty(_adminMsg))
                            {
                                <div class="alert alert-info py-2 mb-3">@_adminMsg</div>
                            }

                            <div class="row text-center">
                                <div class="col-12 col-md-4 mb-3">
                                    <div class="border rounded p-3 h-100">
                                        <div class="text-muted small">Versión</div>
                                        <div class="lead">@(_adminVersion ?? "—")</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4 mb-3">
                                    <div class="border rounded p-3 h-100">
                                        <div class="text-muted small">Fecha</div>
                                        <div class="lead">@(_adminFecha ?? "—")</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4 mb-3">
                                    <div class="border rounded p-3 h-100">
                                        <div class="text-muted small">IPs</div>
                                        @if (_adminIPs.Count == 0)
                                        {
                                            <div class="lead">—</div>
                                        }
                                        else
                                        {
                                            <ul class="list-unstyled m-0">
                                                @foreach (var ip in _adminIPs)
                                                {
                                                    <li class="lead">@ip</li>
                                                }
                                            </ul>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (_adminBusy)
                            {
                                <div class="text-center mt-3">
                                    <div class="spinner-border text-primary" role="status"><span class="sr-only">Cargando…</span></div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

@code {
    enum Screen { Select, Loading, ChooseAsset, ScanQr, DevolucionSetEstado, Result, SecretPin, Admin }
    Screen _screen = Screen.Select;

    // entrada
    private string? _rfid;
    private AssetsAccion? _accion;
    private DateTime _readAt;


    // respuesta SendRequest
    private string _employeeName = "";
    private List<ShortAsset> _assets = new();
    private ShortAsset? _selectedAsset;

    // devolución: estado del activo (guardado pero no usado aún para el backend)
    private AssetsEstado? _devolEstado;

    // resultado final
    private string _resultRaw = "";
    private int _countdown = 20;
    private const int _resultSeconds = 20;
    private CancellationTokenSource? _countdownCts;
    private bool _sending;
    private string _loadingText = "Enviando solicitud…";

    // JS / SignalR
    private IJSObjectReference? _scannerModule;
    private DotNetObjectReference<Assets>? _selfRef;
    private HubConnection? _hub;            // RFID
    private HubConnection? QRhubConnection; // QR
    
    // para el pin para la pantalla de seguridad 
    private string _pinInput = "";
    private const int _pinMax = 8;
    private const string _adminPin = "39426641";

    // --- Admin ---
    private bool _adminBusy;
    private string? _adminVersion;
    private string? _adminFecha;
    private List<string> _adminIPs = new();
    private string? _adminMsg;


    // --- init ---
    protected override async Task OnInitializedAsync()
    {
        // Hub de QR
        QRhubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/QRReaderHub"))
            .WithAutomaticReconnect()
            .Build();

        QRhubConnection.On<string>("ReceiveToken", (string text) =>
        {
            if (_screen != Screen.ScanQr) return;      // solo escuchamos durante el escaneo de QR
            HandleQrScan(text);
        });

        // Hub de RFID
        _hub = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/RFIDReaderHub"))
            .WithAutomaticReconnect()
            .Build();

        _hub.On<string>("ReceiveRFID", token =>
        {
            if (_screen != Screen.Select) return;
            SetRfid(token);
        });

        await _hub.StartAsync();
        await QRhubConnection.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        _scannerModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/LectorRFID.js");
        _selfRef = DotNetObjectReference.Create(this);
        await _scannerModule.InvokeVoidAsync("attach", _selfRef, new { acceptTabAsEnter = true });
    }

    [JSInvokable]
    public async Task OnScanEnter(string text)
    {
        if (_screen != Screen.Select) return;
        SetRfid(text);

        if (_hub is not null && _hub.State == HubConnectionState.Connected)
            await _hub.SendAsync("SendToken", text);
    }

    private void SetRfid(string token)
    {
        _rfid = token;
        _readAt = DateTime.Now;
        _ = TryProceedAsync();
        StateHasChanged();
    }

    bool IsSelected(AssetsAccion a) => _accion == a;
    void SelectAccion(AssetsAccion a)
    {
        if (_accion == a)
        {
            // si toco la misma, deselecciono
            _accion = null;
            StateHasChanged();
            return;
        }

        _accion = a;
        _ = TryProceedAsync();
        StateHasChanged();
    }

    // --- paso 1: enviar solicitud y ramificar ---
    async Task TryProceedAsync()
    {
        if (_sending) return;
        if (string.IsNullOrWhiteSpace(_rfid) || _accion is null) return;

        _sending = true;
        _loadingText = "Enviando solicitud…";
        _screen = Screen.Loading;
        StateHasChanged();

        try
        {
            var req = new AssetsRequest { IdEmpleado = _rfid!, Accion = _accion.Value };
            var resp = await Cliente.SendRequest(req);

            _employeeName = resp?.NombreEmpleado ?? "";
            _assets = resp?.AssetsList ?? new List<ShortAsset>();

            if (_accion == AssetsAccion.Retiro)
            {
                _selectedAsset = null;
                _screen = Screen.ChooseAsset;
            }
            else // Devolución
            {
                if (_assets.Count == 0)
                {
                    _resultRaw = "No hay activos disponibles para devolución.";
                    GoResult();
                }
                else
                {
                    _selectedAsset = null;
                    _devolEstado = null;
                    _screen = Screen.ScanQr; // esperar QR del activo
                }
            }
        }
        catch (Exception ex)
        {
            _resultRaw = $"ERROR: {ex.Message}";
            GoResult();
        }
        finally
        {
            _sending = false;
            StateHasChanged();
        }
    }

    // --- RETIRO ---
    void SelectAsset(ShortAsset a) => _selectedAsset = a;
    async Task GoConfirmRetiro()
    {
        if (_selectedAsset == null) return;
        await SendRetiro();
    }
    void CancelConfirm() => _screen = Screen.ChooseAsset;

    async Task SendRetiro()
    {
        if (_selectedAsset == null) return;
        _loadingText = "Procesando retiro…";
        _screen = Screen.Loading;
        StateHasChanged();

        try
        {
            var ret = await Cliente.OpenBoxByFisico(_selectedAsset.IdBox);
            _resultRaw = ret.ToString() ?? "OK";

            var evt = new AssetsHistorial
            {
                IdAsset = _selectedAsset.IdAsset,
                IdEmpleado = _rfid!,
                Evento = AssetsEvento.CheckOut,
                FechaEvento = DateTime.Now
            };
            await Cliente.ReportEvento(evt);

            GoResult();
        }
        catch (Exception ex)
        {
            _resultRaw = $"ERROR: {ex.Message}";
            GoResult();
        }
    }

    string AssetStateClass(ShortAsset a)
    {
        // Rojo si Defectuoso; Amarillo si NO es Funcional ; (Funcional sin clase)
        return a.Estado == AssetsEstado.Defectuoso
            ? "asset-defectuoso"
            : (a.Estado == AssetsEstado.Funcional ? "" : "asset-warning");
    }

    string AssetCardClasses(ShortAsset a, bool isSel)
    {
        var state = AssetStateClass(a);
        return $"{(isSel ? "selected" : "border-secondary")} {state}".Trim();
    }

    // --- DEVOLUCIÓN ---
    void HandleQrScan(string text)
    {
        var match = _assets.FirstOrDefault(a => string.Equals(a.IdAsset, text?.Trim(), StringComparison.OrdinalIgnoreCase));
        if (match == null)
        {
            _resultRaw = "Activo no registrado";
            GoResult();
            return;
        }

        _selectedAsset = match;
        _devolEstado = null;
        _screen = Screen.DevolucionSetEstado;
        StateHasChanged();
    }

    void SelectEstado(AssetsEstado estado) => _devolEstado = estado;

    async Task ProceedDevolucion()
    {
        if (_selectedAsset == null) return;

        // (Guardamos el estado elegido en memoria para usarlo luego en backend si hace falta)
        var estadoElegido = _devolEstado;

        _loadingText = "Procesando devolución…";
        _screen = Screen.Loading;
        StateHasChanged();

        try
        {
            var ret = await Cliente.OpenBoxByFisico(_selectedAsset.IdBox);
            _resultRaw = ret.ToString() ?? "OK";

            var evt = new AssetsHistorial
            {
                IdAsset = _selectedAsset.IdAsset,
                IdEmpleado = _rfid!,
                Evento = AssetsEvento.CheckIn,
                EstadoNuevo = estadoElegido,
                FechaEvento = DateTime.Now
            };
            await Cliente.ReportEvento(evt);

            GoResult();
        }
        catch (Exception ex)
        {
            _resultRaw = $"ERROR: {ex.Message}";
            GoResult();
        }
    }

    // --- Result + countdown ---
    void GoResult()
    {
        _screen = Screen.Result;
        _countdownCts?.Cancel();
        _countdownCts = new CancellationTokenSource();
        _ = StartCountdownAsync(_resultSeconds, _countdownCts.Token);
    }

    async Task StartCountdownAsync(int seconds, CancellationToken token)
    {
        _countdown = seconds;
        await InvokeAsync(StateHasChanged);

        while (_countdown > 0 && !token.IsCancellationRequested)
        {
            try { await Task.Delay(1000, token); } catch { break; }
            _countdown--;
            await InvokeAsync(StateHasChanged);
        }
        if (!token.IsCancellationRequested) Reset();
    }

    void Reset()
    {
        _countdownCts?.Cancel();

        _rfid = null;
        _accion = null;
        _employeeName = "";
        _assets.Clear();
        _selectedAsset = null;
        _devolEstado = null;

        _resultRaw = "";
        _screen = Screen.Select;
        StateHasChanged();
    }

    string PercentDone()
    {
        var done = (_resultSeconds - _countdown) * 100 / Math.Max(1, _resultSeconds);
        return done + "%";
    }

    // PANTALLA DE ID
    void PinAdd(string d)
    {
        if (_pinInput.Length < _pinMax)
            _pinInput += d;
    }

    void PinBackspace()
    {
        if (_pinInput.Length > 0)
            _pinInput = _pinInput[..^1];
    }

    void PinClear() => _pinInput = "";

    void PinCancel()
    {
        _pinInput = "";
        _screen = Screen.Select;
    }

    async Task SubmitPin()
    {
        var pin = _pinInput;
        _pinInput = "";

        if (pin == _adminPin)
        {
            _screen = Screen.Admin;
            StateHasChanged();
            await LoadAdminAsync();
        }
        else
        {
            // PIN incorrecto → volver a la pantalla principal
            PinCancel();
        }
    }

    async Task LoadAdminAsync()
    {
        _adminBusy = true;
        _adminMsg = null;
        _adminVersion = null;
        _adminFecha = null;
        _adminIPs.Clear();
        StateHasChanged();

        try
        {
            _adminVersion = await Cliente.GetVersion();
            _adminFecha = await Cliente.GetFecha();
            var nets = await Cliente.System_GetIP(); // devuelve SystemNetwork[]
            if (nets != null)
                _adminIPs = nets
                    .Select(n => n?.IP)
                    .Where(ip => !string.IsNullOrWhiteSpace(ip))
                    .Distinct()
                    .ToList();
        }
        catch (Exception ex)
        {
            _adminMsg = $"ERROR: {ex.Message}";
        }
        finally
        {
            _adminBusy = false;
            StateHasChanged();
        }
    }

    async Task AdminShutdown()
    {
        if (_adminBusy) return;
        _adminBusy = true; _adminMsg = "Enviando apagado…"; StateHasChanged();
        try { await Cliente.System_Shutdown(); _adminMsg = "Comando de apagado enviado."; }
        catch (Exception ex) { _adminMsg = $"ERROR: {ex.Message}"; }
        finally { _adminBusy = false; StateHasChanged(); }
    }

    async Task AdminReset()
    {
        if (_adminBusy) return;
        _adminBusy = true; _adminMsg = "Enviando reinicio…"; StateHasChanged();
        try { await Cliente.System_Reset(); _adminMsg = "Comando de reinicio enviado."; }
        catch (Exception ex) { _adminMsg = $"ERROR: {ex.Message}"; }
        finally { _adminBusy = false; StateHasChanged(); }
    }

    async Task AdminUpdate()
    {
        if (_adminBusy) return;
        _adminBusy = true; _adminMsg = "Enviando actualización…"; StateHasChanged();
        try { await Cliente.System_Update(); _adminMsg = "Comando de actualización enviado."; }
        catch (Exception ex) { _adminMsg = $"ERROR: {ex.Message}"; }
        finally { _adminBusy = false; StateHasChanged(); }
    }

    void AdminBack() { _screen = Screen.Select; }


    // --- dispose ---
    public async ValueTask DisposeAsync()
    {
        try { if (_scannerModule != null) await _scannerModule.InvokeVoidAsync("detach"); } catch { }
        _selfRef?.Dispose();

        try { if (_hub != null) { await _hub.StopAsync(); await _hub.DisposeAsync(); } } catch { }
        try { if (QRhubConnection != null) { await QRhubConnection.StopAsync(); await QRhubConnection.DisposeAsync(); } } catch { }
        try { _countdownCts?.Cancel(); } catch { }
    }

}
