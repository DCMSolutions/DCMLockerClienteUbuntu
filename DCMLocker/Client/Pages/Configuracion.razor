@page "/configuracion"

<h1>Locker</h1>
<label><strong>Configuración</strong></label>

@if (Config != null)
{
    <div class="p-5">

        <hr><br>

        <form class="user">

            <div class="form-group">
                <label><strong>ID Locker</strong></label>
                <p>Identificador único de locker.</p>
                <p>Es utilizado para identificar a un locker en un sistema central.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="text" @bind="Config.LockerID" class="form-control form-control-user col-3" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>URL Servidor</strong></label>
                <p>Configuración de la dirección que corresponde al servidor central donde se conectará el Locker.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="text" @bind="url" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Configuración de modo</strong></label>
                <p>Seleccione el modo de uso.</p>

                <div class="d-flex justify-content-center">
                    <RadzenDropDown @bind-Value="SystemConfig.Modo"
                                    Data="@_modos"
                                    TextProperty="Label"
                                    ValueProperty="Value"
                                    Style="width: 320px"
                                    Placeholder="Seleccione un modo"
                                    AllowClear="false" />
                </div>
                <div class="d-flex justify-content-center mt-2">
                    <RadzenBadge Text="@ModoLabelActual" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de envío de status</strong></label>
                <p>Configuración del intervalo entre cada envío de estado, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.DelayStatus" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de pestaña superadmin</strong></label>
                <p>Configuración del tiempo que se tarda en volver de la pestaña de super-administrador, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.SuperadminTime" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de pestaña admin</strong></label>
                <p>Configuración del tiempo que se tarda en volver de la pestaña de administrador, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.AdminTime" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempos de pantallas</strong></label>
                <p>Duración (ms) de los mensajes/resultados en el flujo de Assets.</p>

                <hr class="my-3" />

                <div class="mb-3">
                    <label><strong>Activo no registrado</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje cuando el TAG/asset no existe.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeActivoNoRegistrado" class="form-control form-control-user col-6" />
                    </div>
                </div>

                <div class="mb-3">
                    <label><strong>Operación cancelada</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje de cancelación.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeOperacionCancelada" class="form-control form-control-user col-6" />
                    </div>
                </div>

                <div class="mb-3">
                    <label><strong>Usuario no registrado</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje cuando la tarjeta/empleado no existe.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeUsuarioNoRegistrado" class="form-control form-control-user col-6" />
                    </div>
                </div>

                <div class="mb-3">
                    <label><strong>No hay activos disponibles</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje cuando no hay activos para la acción.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeNoHayActivosDisponibles" class="form-control form-control-user col-6" />
                    </div>
                </div>

                <div class="mb-3">
                    <label><strong>No hay boxes disponibles</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje cuando no hay box asignable/usable.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeNoHayBoxesDisponibles" class="form-control form-control-user col-6" />
                    </div>
                </div>

                <div class="mb-2">
                    <label><strong>Operación exitosa</strong></label>
                    <p class="mb-1">Tiempo que se muestra el mensaje de operación exitosa.</p>
                    <div style="display: flex; justify-content: center;">
                        <input type="number" @bind="SystemConfig.TimeOperacionExitosa" class="form-control form-control-user col-6" />
                    </div>
                </div>
            </div>

            <hr><br>

            <button type="button" class="btn btn-primary btn-user btn-block" @onclick="Save">Guardar</button>

        </form>
    </div>
}
else
{
    <div class="abs-center">
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-secondary"></div>
    </div>
}

@code {
    // Tu config “vieja” (LockerID / UrlServer) se mantiene
    LockerConfig Config;
    string url;

    // Config unificada (Modo/DelayStatus/AdminTime/SuperadminTime + tiempos Assets rápido)
    // Importante: solo new(), sin defaults de modo “por adelantado”.
    Config2 SystemConfig = new();

    // Para evitar escribir si no hubo cambios.
    private string? _originalModo;
    private int _originalDelayStatus;
    private int _originalSuperadminTime;
    private int _originalAdminTime;

    private int _originalTimeActivoNoRegistrado;
    private int _originalTimeOperacionCancelada;
    private int _originalTimeUsuarioNoRegistrado;
    private int _originalTimeNoHayActivosDisponibles;
    private int _originalTimeNoHayBoxesDisponibles;
    private int _originalTimeOperacionExitosa;

    private readonly List<ModeOption> _modos = new()
    {
        new("tokens", "Tokens"),
        new("assets", "Assets"),
        new("assetsRapido", "Assets rápido"),
    };

    private string ModoLabelActual =>
        _modos.FirstOrDefault(x => string.Equals(x.Value, SystemConfig.Modo, StringComparison.OrdinalIgnoreCase))?.Label ?? "—";

    private record ModeOption(string Value, string Label);

    protected override async Task OnInitializedAsync()
    {
        // 1) Config unificada (Config2)
        SystemConfig = await Cliente.GetConfigAsync() ?? new Config2();

        // Normalización defensiva (sin “inicializar por adelantado”)
        if (string.IsNullOrWhiteSpace(SystemConfig.Modo))
            SystemConfig.Modo = "tokens";

        _originalDelayStatus = SystemConfig.DelayStatus;
        _originalSuperadminTime = SystemConfig.SuperadminTime;
        _originalAdminTime = SystemConfig.AdminTime;
        _originalModo = SystemConfig.Modo;

        _originalTimeActivoNoRegistrado = SystemConfig.TimeActivoNoRegistrado;
        _originalTimeOperacionCancelada = SystemConfig.TimeOperacionCancelada;
        _originalTimeUsuarioNoRegistrado = SystemConfig.TimeUsuarioNoRegistrado;
        _originalTimeNoHayActivosDisponibles = SystemConfig.TimeNoHayActivosDisponibles;
        _originalTimeNoHayBoxesDisponibles = SystemConfig.TimeNoHayBoxesDisponibles;
        _originalTimeOperacionExitosa = SystemConfig.TimeOperacionExitosa;

        // 2) Config anterior del locker (si todavía la usás)
        Config = await Cliente.GetConfig();
        url = $"{Config.UrlServer}";
    }

    async Task Save()
    {
        try
        {
            // Validación/normalización URL servidor (config antigua)
            var uriBuilder = new UriBuilder(url);
            Config.UrlServer = uriBuilder.Uri;

            // Validación simple de tiempos (no negativos)
            if (SystemConfig.DelayStatus < 0) SystemConfig.DelayStatus = 0;
            if (SystemConfig.SuperadminTime < 0) SystemConfig.SuperadminTime = 0;
            if (SystemConfig.AdminTime < 0) SystemConfig.AdminTime = 0;

            if (SystemConfig.TimeActivoNoRegistrado < 0) SystemConfig.TimeActivoNoRegistrado = 0;
            if (SystemConfig.TimeOperacionCancelada < 0) SystemConfig.TimeOperacionCancelada = 0;
            if (SystemConfig.TimeUsuarioNoRegistrado < 0) SystemConfig.TimeUsuarioNoRegistrado = 0;
            if (SystemConfig.TimeNoHayActivosDisponibles < 0) SystemConfig.TimeNoHayActivosDisponibles = 0;
            if (SystemConfig.TimeNoHayBoxesDisponibles < 0) SystemConfig.TimeNoHayBoxesDisponibles = 0;
            if (SystemConfig.TimeOperacionExitosa < 0) SystemConfig.TimeOperacionExitosa = 0;

            // Guardar config antigua del locker
            bool okLocker = await Cliente.SetConfig(Config);

            // Guardar Config2 solo si cambió algo
            bool sysChanged =
                _originalDelayStatus != SystemConfig.DelayStatus ||
                _originalSuperadminTime != SystemConfig.SuperadminTime ||
                _originalAdminTime != SystemConfig.AdminTime ||
                !string.Equals(_originalModo, SystemConfig.Modo, StringComparison.OrdinalIgnoreCase) ||

                _originalTimeActivoNoRegistrado != SystemConfig.TimeActivoNoRegistrado ||
                _originalTimeOperacionCancelada != SystemConfig.TimeOperacionCancelada ||
                _originalTimeUsuarioNoRegistrado != SystemConfig.TimeUsuarioNoRegistrado ||
                _originalTimeNoHayActivosDisponibles != SystemConfig.TimeNoHayActivosDisponibles ||
                _originalTimeNoHayBoxesDisponibles != SystemConfig.TimeNoHayBoxesDisponibles ||
                _originalTimeOperacionExitosa != SystemConfig.TimeOperacionExitosa;

            bool okSystem = true;
            if (sysChanged)
            {
                okSystem = await Cliente.UpdateConfigAsync(SystemConfig);

                if (okSystem)
                {
                    _originalDelayStatus = SystemConfig.DelayStatus;
                    _originalSuperadminTime = SystemConfig.SuperadminTime;
                    _originalAdminTime = SystemConfig.AdminTime;
                    _originalModo = SystemConfig.Modo;

                    _originalTimeActivoNoRegistrado = SystemConfig.TimeActivoNoRegistrado;
                    _originalTimeOperacionCancelada = SystemConfig.TimeOperacionCancelada;
                    _originalTimeUsuarioNoRegistrado = SystemConfig.TimeUsuarioNoRegistrado;
                    _originalTimeNoHayActivosDisponibles = SystemConfig.TimeNoHayActivosDisponibles;
                    _originalTimeNoHayBoxesDisponibles = SystemConfig.TimeNoHayBoxesDisponibles;
                    _originalTimeOperacionExitosa = SystemConfig.TimeOperacionExitosa;
                }
            }

            if (okLocker && okSystem)
            {
                ShowNotification(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Exito",
                    Detail = "Se guardaron con éxito los cambios.",
                    Duration = 4000
                });
            }
            else
            {
                ShowNotification(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Hubo un error en el guardado.",
                    Duration = 4000
                });
            }
        }
        catch
        {
            ShowNotification(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Url del servidor no válido.",
                Duration = 4000
            });
        }
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }
}
