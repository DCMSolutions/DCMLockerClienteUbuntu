@page "/configuracion"

<h1>Locker</h1>
<label><strong>Configuración</strong></label>

@if (Config != null)
{
    <div class="p-5">

        <hr><br>

        <form class="user">

            <div class="form-group">
                <label><strong>ID Locker</strong></label>
                <p>Identificador único de locker.</p>
                <p>Es utilizado para identificar a un locker en un sistema central.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="text" @bind="Config.LockerID" class="form-control form-control-user col-3" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>URL Servidor</strong></label>
                <p>Configuración de la dirección que corresponde al servidor central donde se conectará el Locker.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="text" @bind="url" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Configuración de modo</strong></label>
                <p>Seleccione el modo de uso.</p>

                <div class="d-flex justify-content-center">
                    <RadzenDropDown @bind-Value="SystemConfig.Modo"
                                    Data="@_modos"
                                    TextProperty="Label"
                                    ValueProperty="Value"
                                    Style="width: 320px"
                                    Placeholder="Seleccione un modo"
                                    AllowClear="false" />
                </div>
                <div class="d-flex justify-content-center mt-2">
                    <RadzenBadge Text="@ModoLabelActual" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de envío de status</strong></label>
                <p>Configuración del intervalo entre cada envío de estado, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.DelayStatus" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de pestaña superadmin</strong></label>
                <p>Configuración del tiempo que se tarda en volver de la pestaña de super-administrador, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.SuperadminTime" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <div class="form-group">
                <label><strong>Tiempo de pestaña admin</strong></label>
                <p>Configuración del tiempo que se tarda en volver de la pestaña de administrador, en milisegundos.</p>
                <div style="display: flex; justify-content: center;">
                    <input type="number" @bind="SystemConfig.AdminTime" class="form-control form-control-user col-6" />
                </div>
            </div>

            <hr><br>

            <button type="button" class="btn btn-primary btn-user btn-block" @onclick="Save">Guardar</button>

        </form>
    </div>
}
else
{
    <div class="abs-center">
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-secondary"></div>
    </div>
}

@code {
    // Tu config “vieja” (LockerID / UrlServer) se mantiene
    LockerConfig Config;
    string url;

    // Nueva config unificada (Modo/DelayStatus/AdminTime/SuperadminTime)
    // Default defensivo para que el primer render sea válido.
    Config2 SystemConfig = new Config2 { Modo = "tokens" };

    // Para evitar escribir si no hubo cambios (opcional, pero útil).
    private string _originalModo;
    private int _originalDelayStatus;
    private int _originalSuperadminTime;
    private int _originalAdminTime;

    private readonly List<ModeOption> _modos = new()
    {
        new("tokens", "Tokens"),
        new("assets", "Assets"),
        new("assetsRapido", "Assets rápido"),
    };

    private string ModoLabelActual =>
        _modos.FirstOrDefault(x => string.Equals(x.Value, SystemConfig.Modo, StringComparison.OrdinalIgnoreCase))?.Label ?? "—";

    private record ModeOption(string Value, string Label);

    protected override async Task OnInitializedAsync()
    {
        // 1) Config unificada (Config2)
        SystemConfig = await Cliente.GetConfigAsync();

        _originalDelayStatus = SystemConfig.DelayStatus;
        _originalSuperadminTime = SystemConfig.SuperadminTime;
        _originalAdminTime = SystemConfig.AdminTime;
        _originalModo = SystemConfig.Modo;

        // 2) Config anterior del locker (si todavía la usás)
        Config = await Cliente.GetConfig();
        url = $"{Config.UrlServer}";
    }

    async Task Save()
    {
        try
        {
            // Validación/normalización URL servidor (config antigua)
            var uriBuilder = new UriBuilder(url);
            Config.UrlServer = uriBuilder.Uri;

            // Guardar config antigua del locker
            bool okLocker = await Cliente.SetConfig(Config);

            // Guardar Config2 solo si cambió algo
            bool sysChanged =
                _originalDelayStatus != SystemConfig.DelayStatus ||
                _originalSuperadminTime != SystemConfig.SuperadminTime ||
                _originalAdminTime != SystemConfig.AdminTime ||
                !string.Equals(_originalModo, SystemConfig.Modo, StringComparison.OrdinalIgnoreCase);

            bool okSystem = true;
            if (sysChanged)
            {
                okSystem = await Cliente.UpdateConfigAsync(SystemConfig);

                if (okSystem)
                {
                    // Actualizamos los “originales” para que no vuelva a intentar guardar si no cambió nada
                    _originalDelayStatus = SystemConfig.DelayStatus;
                    _originalSuperadminTime = SystemConfig.SuperadminTime;
                    _originalAdminTime = SystemConfig.AdminTime;
                    _originalModo = SystemConfig.Modo;
                }
            }

            if (okLocker && okSystem)
            {
                ShowNotification(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Exito",
                    Detail = "Se guardaron con éxito los cambios.",
                    Duration = 4000
                });
            }
            else
            {
                ShowNotification(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Hubo un error en el guardado.",
                    Duration = 4000
                });
            }
        }
        catch
        {
            ShowNotification(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Url del servidor no válido.",
                Duration = 4000
            });
        }
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }
}
